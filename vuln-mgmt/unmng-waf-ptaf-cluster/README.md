# Пример установки cluster WAF PTAF (Positive Tech. WAF) в Yandex.Cloud 


## Описание:
В рамках workshop будут выполнены:
- установка инфраструктуры с помощью terraform (infrastructure as a code)
- инсталяция и базовая конфигурация PTAF cluster в 2-х зонах доступности Yandex.Cloud

#### Сценарий окружения:
Предполагается, что в Yandex.Cloud уже развернут небезопасный сценарий: ВМ с веб приложениями в 2-х зонах доступности. Также внешний сетевой балансировщик нагрузки. 


#### Схема до:
![ha-proxy-До](https://user-images.githubusercontent.com/85429798/126472644-005bc453-95c4-4f50-8a01-adcd0ece75d0.jpg)



#### Схема после:
![ha-proxy-после](https://user-images.githubusercontent.com/85429798/126472688-daa34151-9e3a-413e-a087-22bf0c18952f.jpg)



## Подготовка/Пререквизиты:
- установить и настроить [yc client](https://cloud.yandex.ru/docs/cli/quickstart)
- установить [terraform](https://www.terraform.io/downloads.html)
- скачать архив с файлами "..zip"


## Развертывание

#### Развертывание terraform:
- перейти в папку с файлами
- вставить необходимые параметры в файле variables.tf (в комментариях указаны необходимые команды yc для получения значений)
- выполнить команду инициализации terraform

```
terraform init

```
- выполнить команду импорта load-balancer

```
terraform import yandex_lb_network_load_balancer.ext-lb $(yc load-balancer network-load-balancer list --format=json | jq '.[].id' | sed 's/"//g') 
```

- выполнить команду запуска terraform
```
terraform apply
```

#### Развертывание ручные действия:
- включить NAT на subnet: ext-subnet-a, ext-subnet-b (для того, чтобы PTAF мог выходить в интернет за обновлениями и др.)
- назначить Security Group "app-sg" на ВМ: app-a, app-b



##

## Описание шагов работы с PTAF:

- пробрасываем порты по SSH для подключения к серверам PT AF:

ssh -L 22001:192.168.2.10:22013 -L 22002:172.18.0.10:22013 -L 8443:192.168.2.10:8443 -L 8444:172.18.0.10:8444 -i ./pt_key yc-user@$(yc compute instance list --format=json | jq '.[] | select( .name == "ssh-a")| .network_interfaces[0].primary_v4_address.one_to_one_nat.address '| sed 's/"//g') 


#### Общая настройка двух серверов.

- настройте на каждом из серверов пароль пользователя pt. пароль по умолчанию - positive.
подключаемся к серверам PT AF С ТЕКУЩЕГО ОКНА ТЕРМИНАЛА по SSH используя команды для 1-го и 2-го PTAF (желательно в 2 разных окна):

ssh pt@192.168.2.10 -p 22013 
ssh pt@172.18.0.10 -p 22013

- выберите вариант 0 - Exit to WSC и нажмите Enter.
- введите по очереди команды:

host add 192.168.2.10 ptaf-a
host add 172.18.0.10 ptaf-b

config commit

- дождитесь окончания записи новой конфигурации:

██████████████████████████████████████████████████ 100 %                                                                            
config commit done                                                                                                                  
wsc>


#### Настройка slave-сервера
- подключитесь к ptaf-b: 
ssh pt@172.18.0.10 -p 22013

- введите команду

password set <мастер-пароль> (должен совпадать с тем, который задан на узле master). 
 
-  выйдет сообщение: "It doesn't look like this password is autogenerated. Use it anyway? (y/n)". нажмите Y.

cluster set mongo replset waf
cluster set elastic replset waf
cluster set elastic nodes ptaf-b ptaf-a

#### Настройка master-сервера
- подключитесь к ptaf-a: 
ssh pt@192.168.2.10 -p 22013 
- выполните команду:

password set <мастер-пароль> (должен совпадать с тем, который задан на узле slave).  

-  выйдет сообщение: "It doesn't look like this password is autogenerated. Use it anyway? (y/n)". нажмите Y.

cluster set mongo replset waf
cluster set mongo nodes ptaf-b
cluster set elastic replset waf
cluster set elastic nodes  ptaf-a ptaf-b

#### Создание кластера

- сначала запустим синхронизацию на SLAVE-сервере использовав команду:

config commit

- дождитесь когда на SLAVE-сервере появится сообщение: "TASK: [mongo | please configure all other nodes of your cluster]". после этого  переключитесь на MASTER-сервер и начните синхронизацию той же командой:

config commit

- eсли конфигурация на узле master остановилась на сообщении TASK: [mongo | please configure all other nodes of your cluster], просто вручную выполните команду config sync на узле SLAVE.

- кластер собран.

