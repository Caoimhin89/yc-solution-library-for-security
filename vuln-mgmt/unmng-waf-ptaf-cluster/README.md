# Пример установки cluster WAF PTAF (Positive Tech. WAF) в Yandex.Cloud 


## Описание:
В рамках workshop будут выполнены:
- установка инфраструктуры с помощью terraform (infrastructure as a code)
- инсталяция и базовая конфигурация PTAF cluster в 2-х зонах доступности Yandex.Cloud

## Сценарий окружения:
Предполагается, что в Yandex.Cloud уже развернут небезопасный сценарий: ВМ с веб приложениями в 2-х зонах доступности. Также внешний сетевой балансировщик нагрузки. 


## Схема до:
![ha-proxy-До](https://user-images.githubusercontent.com/85429798/126472644-005bc453-95c4-4f50-8a01-adcd0ece75d0.jpg)



## Схема после:
![ha-proxy-после](https://user-images.githubusercontent.com/85429798/126472688-daa34151-9e3a-413e-a087-22bf0c18952f.jpg)



## Подготовка/Пререквизиты:
- установить и настроить [yc client](https://cloud.yandex.ru/docs/cli/quickstart)
- установить [terraform](https://www.terraform.io/downloads.html)
- скачать архив с файлами "..zip"



![1200px-Cloud_icon_128x128px svg](https://user-images.githubusercontent.com/85429798/126518741-7207edb2-665c-433b-914f-5a926546666f.png)

## Развертывание terraform:
- перейти в папку с файлами
- вставить необходимые параметры в файле variables.tf (в комментариях указаны необходимые команды yc для получения значений)
- выполнить команду инициализации terraform

```
terraform init

```
- выполнить команду импорта load-balancer

```
terraform import yandex_lb_network_load_balancer.ext-lb $(yc load-balancer network-load-balancer list --format=json | jq '.[].id' | sed 's/"//g') 
```

- выполнить команду запуска terraform
```
terraform apply
```

## Развертывание ручные действия:
- включить NAT на subnet: ext-subnet-a, ext-subnet-b (для того, чтобы PTAF мог выходить в интернет за обновлениями и др.)
- назначить Security Group "app-sg" на ВМ: app-a, app-b




![medium_b56c0eed735f17fb99c3a39771c54eb8](https://user-images.githubusercontent.com/85429798/126518684-88bb3262-401e-4179-8a13-52a17d619a63.png =500x500)

## Описание шагов работы с PTAF:


- пробрасываем порты по SSH для подключения к серверам PT AF:

ssh -L 22001:10.1.0.11:22013 -L 22002:10.2.0.22:22013  -L 8443:10.2.0.22:8443 -L 8443:10.1.0.11:8443 -L 8444:10.2.0.22:8444 имя_пользователя@193.32.219.166

- подключаемся к серверам PT AF по SSH используя команды:

ssh pt@127.0.0.1:22001 и ssh pt@127.0.0.1:22002 

## Общая настройка двух серверов.

- настройте на каждом из серверов пароль пользователя pt. пароль по умолчанию - positive.
- после этого появится запрос "The current hostname of your system is "ptaf-vm". Press "Enter" to use it or type a new one: 
- введите hostname ptaf1 для master-сервера и ptaf2 для slave-сервера. нажмите Enter. после потребуется подождать пока скрипты автоматически пропишут новое имя.
- после окончания применения скриптов вам будет предложено воспользоваться Configuration Wizard. мы будет настраивать все вручную, поэтому выберите вариант 0 - Exit to WSC и нажмите Enter.
- сначала произведем настройки сети. введите по очереди команды:

host add 10.1.0.11 ptaf1
host add 10.2.0.22 ptaf2
if mode eth-ext1 manual
if mode eth-cluster manual
if mode eth-int1 manual
if unmark eth-ext1 eth-int1 eth-cluster
config commit

- дождитесь окончания записи новой конфигурации:

██████████████████████████████████████████████████ 100 %                                                                            
config commit done                                                                                                                  
wsc>


## Настройка slave-сервера
password set <мастер-пароль> (должен совпадать с тем, который задан на узле master).  
-  выйдет сообщение: "It doesn't look like this password is autogenerated. Use it anyway? (y/n)". нажмите Y.

cluster set mongo replset waf
cluster set elastic replset waf
cluster set elastic nodes ptaf2 ptaf1 

## Настройка master-сервера
password set <мастер-пароль> (должен совпадать с тем, который задан на узле slave).  
-  выйдет сообщение: "It doesn't look like this password is autogenerated. Use it anyway? (y/n)". нажмите Y.

cluster set mongo replset waf
cluster set mongo nodes  ptaf2
cluster set elastic replset waf
cluster set elastic nodes  ptaf1 ptaf2

## Создание кластера

- сначала запустим синхронизацию на SLAVE-сервере использовав команду:
config commit

- дождитесь когда на SLAVE-сервере появится сообщение: "TASK: [mongo | please configure all other nodes of your cluster]". после этого  переключитесь на MASTER-сервер и начните синхронизацию той же командой:
config commit

- eсли конфигурация на узле master остановилась на сообщении TASK: [mongo | please configure all other nodes of your cluster], просто вручную выполните команду config sync на узле SLAVE.

- кластер собран.

## Активация лицензии

- откройте веб-консоль Application Firewall через web-браузер на http://127.0.0.1:8443. авторизуйтесь, используя логин admin и пароль positive
- на первой странице смените пароль: введите один раз действующий пароль и два раза новый
- Выберите вкладку System и пункт About. нажмите на зеленую кнопку Upload License и загрузите файл-лицензии в формате *******.v2c. Поставьте лицензию аналогично и на второй узел, выбрав его сверху на этой же странице.
